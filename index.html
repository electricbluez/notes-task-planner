<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notes & Task Planner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f8f9fa;
        }

        /* Header */
        .header {
            background: white;
            border-bottom: 1px solid #e9ecef;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: #007bff;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 14px;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 6px;
            color: #28a745;
            font-size: 12px;
        }

        .sync-dot {
            width: 8px;
            height: 8px;
            background: #28a745;
            border-radius: 50%;
        }

        .sync-status.error .sync-dot {
            background: #dc3545;
        }

        .sync-status.error {
            color: #dc3545;
        }

        .sign-out-btn {
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            font-size: 14px;
            text-decoration: underline;
        }

        .sign-out-btn:hover {
            color: #495057;
        }

        /* Auth Section */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
        }

        .auth-card {
            background: white;
            padding: 48px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .auth-icon {
            width: 64px;
            height: 64px;
            background: #007bff;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            color: white;
            font-size: 24px;
        }

        .auth-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .auth-subtitle {
            color: #6c757d;
            margin-bottom: 32px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #495057;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }

        .auth-btn {
            width: 100%;
            padding: 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .auth-btn:hover {
            background: #0056b3;
        }

        .auth-footer {
            margin-top: 24px;
            font-size: 12px;
            color: #6c757d;
        }

        /* Main Layout */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 32px;
            background: white;
            border-radius: 12px 12px 0 0;
            overflow: hidden;
        }

        .nav-tab {
            flex: 1;
            padding: 16px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
        }

        .nav-tab.active {
            color: #007bff;
            background: white;
        }

        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #007bff;
        }

        .nav-tab:hover:not(.active) {
            background: #f8f9fa;
            color: #495057;
        }

        .tab-icon {
            font-size: 18px;
        }

        /* Tab Content */
        .tab-content {
            background: white;
            border-radius: 0 0 12px 12px;
            min-height: 600px;
        }

        .tab-pane {
            display: none;
            padding: 32px;
        }

        .tab-pane.active {
            display: block;
        }

        /* Form Sections */
        .section-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 24px;
            color: #2c3e50;
        }

        .input-row {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            align-items: end;
        }

        .input-group {
            flex: 1;
        }

        .input-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #495057;
            font-size: 14px;
        }

        .text-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .text-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }

        .text-area {
            resize: vertical;
            min-height: 120px;
        }

        .select-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .select-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }

        .primary-btn {
            padding: 12px 24px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .primary-btn:hover {
            background: #0056b3;
        }

        .secondary-btn {
            padding: 8px 16px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .secondary-btn:hover {
            background: #545b62;
        }

        .success-btn {
            background: #28a745;
        }

        .success-btn:hover {
            background: #218838;
        }

        /* Controls Bar */
        .controls-bar {
            display: flex;
            gap: 16px;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .view-toggle {
            display: flex;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            overflow: hidden;
        }

        .toggle-btn {
            padding: 8px 16px;
            background: white;
            border: none;
            cursor: pointer;
            font-size: 14px;
            color: #6c757d;
            transition: all 0.2s;
        }

        .toggle-btn.active {
            background: #007bff;
            color: white;
        }

        .toggle-btn:hover:not(.active) {
            background: #f8f9fa;
        }

        .filter-select {
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        /* Items List */
        .items-list {
            space-y: 12px;
        }

        .item-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .item-card:hover {
            border-color: #007bff;
            box-shadow: 0 2px 8px rgba(0,123,255,0.1);
        }

        .item-content {
            font-size: 14px;
            margin-bottom: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .item-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 12px;
        }

        .tag {
            background: #e3f2fd;
            color: #1565c0;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .item-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #6c757d;
        }

        .item-date {
            flex: 1;
        }

        .item-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 4px 8px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: #e9ecef;
        }

        .action-btn.danger:hover {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        /* Task Groups */
        .task-groups {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        .task-group {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 16px;
            min-height: 200px;
            transition: all 0.2s;
        }

        .task-group.drag-over {
            border-color: #007bff;
            background: #e3f2fd;
            box-shadow: 0 4px 12px rgba(0,123,255,0.2);
        }

        .task-group.no-group {
            background: #fff8e1;
            border-color: #ffc107;
        }

        .task-group.today-group {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border: 2px solid #007bff;
            box-shadow: 0 2px 8px rgba(0,123,255,0.15);
            order: -1; /* Always appears first */
        }

        .task-group.today-group .group-header {
            border-bottom-color: #007bff;
        }

        .task-group.today-group .group-title {
            color: #007bff;
            font-size: 17px;
        }

        .task-group.today-group .group-count {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .group-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #dee2e6;
        }

        .group-title {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .task-group.no-group .group-title {
            color: #856404;
        }

        .group-title-text {
            flex: 1;
        }

        .group-title-input {
            flex: 1;
            padding: 4px 8px;
            border: 1px solid #007bff;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 600;
            font-family: inherit;
        }

        .group-title-input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }

        .group-count {
            background: #007bff;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .group-actions {
            display: flex;
            gap: 4px;
        }

        .group-action-btn {
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .group-action-btn:hover {
            background: #e9ecef;
            color: #495057;
        }

        /* Task Items in Groups */
        .task-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-height: 60px;
        }

        .task-item-wrapper {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 12px;
            transition: all 0.2s;
        }

        .task-item-wrapper:hover {
            border-color: #007bff;
            box-shadow: 0 2px 8px rgba(0,123,255,0.15);
        }

        .task-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            cursor: move;
        }

        .task-item.dragging {
            opacity: 0.4;
            cursor: grabbing;
        }

        .task-item.completed {
            opacity: 0.6;
        }

        .task-item.completed .task-text {
            text-decoration: line-through;
        }

        .task-drag-handle {
            color: #adb5bd;
            cursor: grab;
            font-size: 16px;
            padding: 0 4px;
            user-select: none;
        }

        .task-drag-handle:active {
            cursor: grabbing;
        }

        .task-checkbox {
            margin-top: 2px;
            cursor: pointer;
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }

        .task-text {
            flex: 1;
            font-size: 14px;
            word-wrap: break-word;
        }

        .task-actions {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .task-item:hover .task-actions {
            opacity: 1;
        }

        .task-action-btn {
            padding: 2px 6px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .task-action-btn:hover {
            background: #e9ecef;
        }

        .task-action-btn.danger:hover {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        /* Task Sub-items */
        .task-subitems {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e9ecef;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .subitem {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 13px;
            margin-left: 28px;
        }

        .subitem.completed {
            opacity: 0.6;
        }

        .subitem.completed .subitem-text {
            text-decoration: line-through;
        }

        .subitem-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .subitem-text {
            flex: 1;
            word-wrap: break-word;
        }

        .subitem-actions {
            display: flex;
            gap: 2px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .subitem:hover .subitem-actions {
            opacity: 1;
        }

        .subitem-btn {
            padding: 2px 4px;
            background: #e9ecef;
            border: 1px solid #dee2e6;
            border-radius: 3px;
            font-size: 9px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .subitem-btn:hover {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        .add-subitem-btn {
            margin-top: 8px;
            margin-left: 28px;
            padding: 6px 10px;
            background: transparent;
            border: 1px dashed #adb5bd;
            border-radius: 4px;
            font-size: 11px;
            color: #6c757d;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .add-subitem-btn:hover {
            border-color: #007bff;
            color: #007bff;
            background: #f8f9fa;
        }

        .task-progress {
            font-size: 11px;
            color: #6c757d;
            margin-left: 8px;
            font-weight: 500;
        }

        .add-subitem-input {
            margin-top: 8px;
            margin-left: 28px;
            display: flex;
            gap: 6px;
        }

        .add-subitem-input input {
            flex: 1;
            padding: 6px 8px;
            border: 1px solid #007bff;
            border-radius: 4px;
            font-size: 12px;
        }

        .add-subitem-input button {
            padding: 4px 8px;
            font-size: 11px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
        }

        .add-subitem-input .save-subitem {
            background: #28a745;
            color: white;
        }

        .add-subitem-input .cancel-subitem {
            background: #6c757d;
            color: white;
        }

        .empty-group {
            text-align: center;
            padding: 32px 16px;
            color: #adb5bd;
            font-size: 14px;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            background: white;
        }

        .empty-icon {
            font-size: 32px;
            margin-bottom: 8px;
            opacity: 0.5;
        }

        /* Reminder specific styles */
        .reminder-due-today {
            border-left: 4px solid #ffc107;
            background: #fff8e1;
        }

        .reminder-overdue {
            border-left: 4px solid #dc3545;
            background: #fff5f5;
        }

        .due-badge {
            background: #ffc107;
            color: #000;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 8px;
            display: inline-block;
        }

        /* Archived items */
        .item-card.archived {
            opacity: 0.7;
            border-left: 4px solid #6c757d;
        }

        /* Empty states */
        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: #6c757d;
        }

        .empty-state .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 24px;
        }

        .modal {
            background: white;
            border-radius: 12px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6c757d;
            padding: 4px;
        }

        .modal-close:hover {
            color: #495057;
        }

        .modal-body {
            padding: 24px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-section {
            margin-bottom: 24px;
        }

        .modal-section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #495057;
        }

        .date-row {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }

        .tag-filters {
            margin-bottom: 16px;
        }

        .available-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }

        .filter-tag {
            padding: 6px 12px;
            border: 1px solid #dee2e6;
            border-radius: 16px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }

        .filter-tag:hover {
            border-color: #007bff;
        }

        .filter-tag.selected {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .selected-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 40px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 8px;
            background: #f8f9fa;
        }

        .selected-tag {
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .remove-tag {
            background: rgba(255,255,255,0.3);
            border: none;
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 10px;
        }

        .report-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 16px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 16px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        /* Edit form styles */
        .edit-form {
            margin-bottom: 12px;
        }

        .edit-textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 1px solid #007bff;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            margin-bottom: 12px;
        }

        .edit-textarea:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }

        .edit-tags {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 12px;
            margin-bottom: 12px;
        }

        .edit-tags:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }

        .edit-actions {
            display: flex;
            gap: 8px;
        }

        .save-btn {
            padding: 6px 12px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            font-weight: 500;
        }

        .save-btn:hover {
            background: #218838;
        }

        .cancel-btn {
            padding: 6px 12px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            font-weight: 500;
        }

        .cancel-btn:hover {
            background: #545b62;
        }

        /* Hidden class */
        .hidden {
            display: none !important;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-container {
                padding: 16px;
            }
            
            .nav-tab {
                padding: 12px 16px;
                font-size: 14px;
            }
            
            .tab-pane {
                padding: 24px 16px;
            }
            
            .input-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .controls-bar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .header {
                padding: 12px 16px;
            }
            
            .user-info {
                flex-direction: column;
                align-items: flex-end;
                gap: 8px;
            }

            .task-groups {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Authentication Section -->
    <div id="authSection" class="auth-container">
        <div class="auth-card">
            <div class="auth-icon">📋</div>
            <h1 class="auth-title">Sign In</h1>
            <p class="auth-subtitle">Access your productivity workspace</p>
            
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" id="emailInput" class="form-input" placeholder="Enter your email">
            </div>
            
            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" id="passwordInput" class="form-input" placeholder="Enter your password">
            </div>
            
            <button onclick="signIn()" class="auth-btn">Sign In</button>
            
            <p class="auth-footer">
                Your data is securely stored and only accessible by authorized users.
            </p>
        </div>
    </div>

    <!-- Main Application -->
    <div id="appContent" class="hidden">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">📋</div>
                Notes & Task Planner
            </div>
            <div class="user-info">
                <div class="sync-status" id="syncStatus">
                    <div class="sync-dot"></div>
                    <span>Synced</span>
                </div>
                <span id="userEmail">test@example.com</span>
                <button class="sign-out-btn" onclick="signOut()">Sign Out</button>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-container">
            <!-- Navigation Tabs -->
            <nav class="nav-tabs">
                <button class="nav-tab active" onclick="switchTab('notes')" id="notesTab">
                    <span class="tab-icon">📝</span>
                    Notes
                </button>
                <button class="nav-tab" onclick="switchTab('reminders')" id="remindersTab">
                    <span class="tab-icon">⏰</span>
                    Reminders
                </button>
                <button class="nav-tab" onclick="switchTab('tasks')" id="tasksTab">
                    <span class="tab-icon">✅</span>
                    Tasks
                </button>
                <button class="nav-tab" onclick="openReportsModal()" id="reportsTab">
                    <span class="tab-icon">📊</span>
                    Reports
                </button>
            </nav>

            <!-- Tab Content -->
            <div class="tab-content">
                <!-- Notes Tab -->
                <div class="tab-pane active" id="notesPane">
                    <h2 class="section-title">Add New Note</h2>
                    
                    <div class="input-group">
                        <label class="input-label">Note Content</label>
                        <textarea id="noteInput" class="text-input text-area" 
                                placeholder="Write your note here... (Ctrl+Enter to save)"></textarea>
                    </div>
                    
                    <div class="input-row">
                        <div class="input-group">
                            <label class="input-label">Tags</label>
                            <input type="text" id="noteTagsInput" class="text-input" 
                                   placeholder="Enter tags separated by commas (e.g., work, important, meeting)">
                        </div>
                        <button onclick="addNote()" class="primary-btn">
                            <span>+</span>
                            Add Note
                        </button>
                    </div>

                    <div class="controls-bar">
                        <div class="view-toggle">
                            <button class="toggle-btn active" onclick="toggleNotesView('active')" id="notesActiveBtn">Active</button>
                            <button class="toggle-btn" onclick="toggleNotesView('archived')" id="notesArchivedBtn">Archived</button>
                        </div>
                        
                        <div id="tagFilterContainer" style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                            <button onclick="toggleTagFilterPanel()" class="secondary-btn" id="tagFilterToggle" style="display: flex; align-items: center; gap: 6px;">
                                <span>🏷️</span>
                                <span id="tagFilterLabel">Filter by tags</span>
                                <span id="tagFilterCount" style="display: none; background: #007bff; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-left: 4px;"></span>
                            </button>
                            <div id="tagFilterPanel" class="hidden" style="position: absolute; background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 100; max-width: 600px; margin-top: 8px;">
                                <div style="margin-bottom: 12px; font-weight: 600; color: #2c3e50; display: flex; justify-content: space-between; align-items: center;">
                                    <span>Select tags to filter:</span>
                                    <button onclick="toggleTagFilterPanel()" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #6c757d;">&times;</button>
                                </div>
                                <div id="tagFilterOptions" style="display: flex; gap: 6px; flex-wrap: wrap; max-height: 200px; overflow-y: auto;">
                                    <!-- Tag filter buttons will be rendered here -->
                                </div>
                                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e9ecef; display: flex; gap: 8px; justify-content: flex-end;">
                                    <button onclick="clearTagFilters()" class="secondary-btn" style="font-size: 11px; padding: 6px 12px;">Clear All</button>
                                </div>
                            </div>
                        </div>
                        
                        <button onclick="archiveOldNotes()" class="secondary-btn">Archive Old Notes</button>
                    </div>

                    <div id="notesList" class="items-list">
                        <!-- Notes will be rendered here -->
                    </div>
                </div>

                <!-- Reminders Tab -->
                <div class="tab-pane" id="remindersPane">
                    <h2 class="section-title">Add New Reminder</h2>
                    
                    <div class="input-row">
                        <div class="input-group">
                            <label class="input-label">Reminder</label>
                            <input type="text" id="reminderText" class="text-input" 
                                   placeholder="What do you need to be reminded about?">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Due Date</label>
                            <input type="date" id="reminderDate" class="text-input">
                        </div>
                        <button onclick="addReminder()" class="primary-btn">
                            <span>⏰</span>
                            Add Reminder
                        </button>
                    </div>

                    <div id="remindersList" class="items-list">
                        <!-- Reminders will be rendered here -->
                    </div>
                </div>

                <!-- Tasks Tab -->
                <div class="tab-pane" id="tasksPane">
                    <h2 class="section-title">Add New Task</h2>
                    
                    <div class="input-row">
                        <div class="input-group">
                            <label class="input-label">Task Description</label>
                            <input type="text" id="taskInput" class="text-input" 
                                   placeholder="What needs to be done? (Press Enter to add)">
                        </div>
                        <div class="input-group" style="max-width: 250px;">
                            <label class="input-label">Add to Group</label>
                            <select id="taskGroupSelect" class="select-input">
                                <option value="">Ungrouped</option>
                            </select>
                        </div>
                        <button onclick="addTask()" class="primary-btn">
                            <span>+</span>
                            Add Task
                        </button>
                    </div>

                    <div class="controls-bar">
                        <div class="view-toggle">
                            <button class="toggle-btn active" onclick="toggleTasksView('active')" id="tasksActiveBtn">Active</button>
                            <button class="toggle-btn" onclick="toggleTasksView('archived')" id="tasksArchivedBtn">Archived</button>
                        </div>
                        
                        <button onclick="showNewGroupPrompt()" class="secondary-btn success-btn">+ New Group</button>
                        <button onclick="archiveCompletedTasks()" class="secondary-btn">Archive Completed</button>
                    </div>

                    <div id="tasksList" class="task-groups">
                        <!-- Task groups will be rendered here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reports Modal -->
    <div id="reportsModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">
                    <span>📊</span>
                    Productivity Report
                </h3>
                <button class="modal-close" onclick="closeReportsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-section">
                    <h4 class="modal-section-title">Date Range</h4>
                    <div class="date-row">
                        <div class="input-group">
                            <label class="input-label">Start Date</label>
                            <input type="date" id="reportStartDate" class="text-input">
                        </div>
                        <div class="input-group">
                            <label class="input-label">End Date</label>
                            <input type="date" id="reportEndDate" class="text-input">
                        </div>
                    </div>
                </div>

                <div class="modal-section">
                    <h4 class="modal-section-title">Tag Filters</h4>
                    <div class="available-tags" id="availableTagsContainer">
                        <!-- Available tags will be rendered here -->
                    </div>
                    <div class="selected-tags" id="selectedTagsContainer">
                        <!-- Selected tags will be rendered here -->
                    </div>
                </div>

                <div class="modal-actions">
                    <button onclick="generateReport()" class="primary-btn">
                        <span>📋</span>
                        Generate Report
                    </button>
                    <button onclick="copyReport()" class="secondary-btn">Copy to Clipboard</button>
                    <button onclick="clearReportTags()" class="secondary-btn">Clear Tag Filters</button>
                </div>

                <div id="reportOutput" class="report-output hidden">
                    Generate a report to see the results here...
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut as firebaseSignOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCBiq3fvCWrOU_TGeIWYH__WFbpuATjGls",
            authDomain: "notes-task-planner.firebaseapp.com",
            databaseURL: "https://notes-task-planner-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "notes-task-planner",
            storageBucket: "notes-task-planner.firebasestorage.app",
            messagingSenderId: "856686025461",
            appId: "1:856686025461:web:b0b86368693a02f79bc3bc"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global state
        let currentUser = null;
        let unsubscribeData = null;
        let currentTab = 'notes';
        let draggedTask = null;
        
        // Data storage
        let data = {
            notes: [],
            reminders: [],
            tasks: [],
            taskGroups: []
        };

        // View state
        let currentView = {
            notes: 'active',
            tasks: 'active'
        };

        // Report filtering state
        let reportTags = new Set();
        
        // Note filtering state
        let selectedNoteTags = new Set();
        let noteFilterMode = 'OR'; // 'OR' or 'AND'
        
        // Today's date (resets at midnight)
        let todayDate = new Date().toDateString();

        // Make functions global for onclick handlers
        window.signIn = signIn;
        window.signOut = signOut;
        window.switchTab = switchTab;
        window.addNote = addNote;
        window.addReminder = addReminder;
        window.addTask = addTask;
        window.toggleTask = toggleTask;
        window.toggleArchive = toggleArchive;
        window.deleteItem = deleteItem;
        window.deleteTask = deleteTask;
        window.editNote = editNote;
        window.saveEdit = saveEdit;
        window.cancelEdit = cancelEdit;
        window.archiveOldNotes = archiveOldNotes;
        window.archiveCompletedTasks = archiveCompletedTasks;
        window.toggleNotesView = toggleNotesView;
        window.toggleTasksView = toggleTasksView;
        window.openReportsModal = openReportsModal;
        window.closeReportsModal = closeReportsModal;
        window.generateReport = generateReport;
        window.copyReport = copyReport;
        window.clearReportTags = clearReportTags;
        window.toggleReportTag = toggleReportTag;
        window.removeReportTag = removeReportTag;
        window.showNewGroupPrompt = showNewGroupPrompt;
        window.deleteGroup = deleteGroup;
        window.startEditGroupName = startEditGroupName;
        window.saveGroupName = saveGroupName;
        window.cancelEditGroupName = cancelEditGroupName;
        window.toggleNoteTag = toggleNoteTag;
        window.clearTagFilters = clearTagFilters;
        window.toggleFilterMode = toggleFilterMode;
        window.toggleTagFilterPanel = toggleTagFilterPanel;
        window.addSubItem = addSubItem;
        window.toggleSubItem = toggleSubItem;
        window.deleteSubItem = deleteSubItem;
        window.showAddSubItemInput = showAddSubItemInput;
        window.saveSubItem = saveSubItem;
        window.cancelAddSubItem = cancelAddSubItem;
        window.toggleTaskToday = toggleTaskToday;

        // Authentication functions
        async function signIn() {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            
            if (!email || !password) {
                alert('Please enter both email and password');
                return;
            }
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showSyncStatus('Signed in successfully!');
            } catch (error) {
                alert('Error signing in: ' + error.message);
            }
        }

        async function signOut() {
            try {
                if (unsubscribeData) {
                    unsubscribeData();
                    unsubscribeData = null;
                }
                await firebaseSignOut(auth);
                showSyncStatus('Signed out');
            } catch (error) {
                alert('Error signing out: ' + error.message);
            }
        }

        // Tab switching
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(tabName + 'Tab').classList.add('active');

            // Update tab panes
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            document.getElementById(tabName + 'Pane').classList.add('active');

            currentTab = tabName;
        }

        // Data persistence functions
        async function saveData() {
            if (!currentUser) return;
            
            try {
                await setDoc(doc(db, 'users', currentUser.uid), data);
                showSyncStatus('Synced');
            } catch (error) {
                console.error('Error saving data:', error);
                showSyncStatus('Sync failed', true);
            }
        }

        async function loadData() {
            if (!currentUser) return;
            
            try {
                const docRef = doc(db, 'users', currentUser.uid);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const savedData = docSnap.data();
                    data = {
                        notes: savedData.notes || [],
                        reminders: savedData.reminders || [],
                        tasks: savedData.tasks || [],
                        taskGroups: savedData.taskGroups || []
                    };
                    
                    // Migrate existing tasks to have groupId if they don't
                    migrateTaskData();
                } else {
                    data = { notes: [], reminders: [], tasks: [], taskGroups: [] };
                    await saveData();
                }
                
                renderAll();
            } catch (error) {
                console.error('Error loading data:', error);
                showSyncStatus('Load failed', true);
            }
        }

        function migrateTaskData() {
            let needsSave = false;
            
            // Add groupId to tasks that don't have it
            data.tasks.forEach(task => {
                if (!task.hasOwnProperty('groupId')) {
                    task.groupId = null;
                    needsSave = true;
                }
                // Add isToday property if missing
                if (!task.hasOwnProperty('isToday')) {
                    task.isToday = false;
                    needsSave = true;
                }
                // Add todayDate property if missing (tracks when it was added to Today)
                if (!task.hasOwnProperty('todayDate')) {
                    task.todayDate = null;
                    needsSave = true;
                }
            });
            
            // Clear today status for tasks that were marked for a previous day
            checkAndClearOldTodayTasks();
            
            // Ensure taskGroups array exists
            if (!data.taskGroups) {
                data.taskGroups = [];
                needsSave = true;
            }
            
            if (needsSave) {
                saveData();
            }
        }
        
        function checkAndClearOldTodayTasks() {
            const currentDateString = new Date().toDateString();
            let needsSave = false;
            
            data.tasks.forEach(task => {
                if (task.isToday && task.todayDate !== currentDateString) {
                    task.isToday = false;
                    task.todayDate = null;
                    needsSave = true;
                }
            });
            
            if (needsSave) {
                saveData();
            }
        }
        
        function toggleTaskToday(taskId) {
            const task = data.tasks.find(t => t.id === taskId);
            if (!task) return;
            
            task.isToday = !task.isToday;
            task.todayDate = task.isToday ? new Date().toDateString() : null;
            
            saveData();
            renderTasks();
        }

        function setupRealtimeSync() {
            if (!currentUser) return;
            
            const docRef = doc(db, 'users', currentUser.uid);
            unsubscribeData = onSnapshot(docRef, (doc) => {
                if (doc.exists()) {
                    const savedData = doc.data();
                    data = {
                        notes: savedData.notes || [],
                        reminders: savedData.reminders || [],
                        tasks: savedData.tasks || [],
                        taskGroups: savedData.taskGroups || []
                    };
                    renderAll();
                }
            });
        }

        function showSyncStatus(message = 'Synced', isError = false) {
            const status = document.getElementById('syncStatus');
            const text = status.querySelector('span');
            
            text.textContent = message;
            status.classList.toggle('error', isError);
            
            // Brief visibility pulse
            status.style.opacity = '1';
            setTimeout(() => {
                if (message === 'Synced') {
                    status.style.opacity = '0.7';
                }
            }, 2000);
        }

        // Core app functions
        function addNote() {
            const input = document.getElementById('noteInput');
            const tagsInput = document.getElementById('noteTagsInput');
            const text = input.value.trim();
            const tagsText = tagsInput.value.trim();
            
            if (text) {
                const tags = tagsText ? tagsText.split(',').map(tag => tag.trim()).filter(tag => tag) : [];
                
                data.notes.unshift({
                    id: Date.now(),
                    text: text,
                    date: new Date().toISOString(),
                    archived: false,
                    tags: tags
                });
                input.value = '';
                tagsInput.value = '';
                saveData();
                renderTagFilters();
                renderNotes();
            }
        }

        function addReminder() {
            const textInput = document.getElementById('reminderText');
            const dateInput = document.getElementById('reminderDate');
            const text = textInput.value.trim();
            const date = dateInput.value;
            
            if (text && date) {
                data.reminders.push({
                    id: Date.now(),
                    text: text,
                    date: date,
                    created: new Date().toISOString()
                });
                textInput.value = '';
                dateInput.value = new Date().toISOString().split('T')[0];
                saveData();
                renderReminders();
            }
        }

        function addTask() {
            const input = document.getElementById('taskInput');
            const groupSelect = document.getElementById('taskGroupSelect');
            const text = input.value.trim();
            const groupId = groupSelect.value || null;
            
            if (text) {
                data.tasks.push({
                    id: Date.now(),
                    text: text,
                    completed: false,
                    created: new Date().toISOString(),
                    completedDate: null,
                    archived: false,
                    groupId: groupId
                });
                input.value = '';
                groupSelect.value = '';
                saveData();
                renderTasks();
            }
        }

        function toggleTask(id) {
            const task = data.tasks.find(t => t.id === id);
            if (task) {
                task.completed = !task.completed;
                task.completedDate = task.completed ? new Date().toISOString() : null;
                saveData();
                renderTasks();
            }
        }

        function toggleArchive(type, id) {
            const item = data[type].find(item => item.id === id);
            if (item) {
                item.archived = !item.archived;
                saveData();
                renderAll();
            }
        }

        function deleteItem(type, id) {
            data[type] = data[type].filter(item => item.id !== id);
            saveData();
            renderAll();
        }

        function deleteTask(id) {
            data.tasks = data.tasks.filter(task => task.id !== id);
            saveData();
            renderTasks();
        }

        // Sub-item functions
        function showAddSubItemInput(taskId) {
            // Hide any existing inputs
            document.querySelectorAll('.add-subitem-input').forEach(input => input.remove());
            
            const taskWrapper = document.querySelector(`[data-task-id="${taskId}"]`);
            const existingInput = taskWrapper.querySelector('.add-subitem-input');
            if (existingInput) return;
            
            const inputHtml = `
                <div class="add-subitem-input">
                    <input type="text" placeholder="Enter sub-item..." id="subitem-input-${taskId}">
                    <button class="save-subitem" onclick="saveSubItem(${taskId})">Add</button>
                    <button class="cancel-subitem" onclick="cancelAddSubItem(${taskId})">✕</button>
                </div>
            `;
            
            // Insert before the add button if it exists, otherwise at the end
            const addButton = taskWrapper.querySelector('.add-subitem-btn');
            if (addButton) {
                addButton.insertAdjacentHTML('beforebegin', inputHtml);
            } else {
                taskWrapper.insertAdjacentHTML('beforeend', inputHtml);
            }
            
            const input = document.getElementById(`subitem-input-${taskId}`);
            input.focus();
            
            // Allow Enter key to save, Escape to cancel
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveSubItem(taskId);
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    cancelAddSubItem(taskId);
                }
            });
        }
        
        function saveSubItem(taskId) {
            const input = document.getElementById(`subitem-input-${taskId}`);
            const text = input.value.trim();
            
            if (text) {
                addSubItem(taskId, text);
            }
            
            cancelAddSubItem(taskId);
        }
        
        function cancelAddSubItem(taskId) {
            const taskWrapper = document.querySelector(`[data-task-id="${taskId}"]`);
            const input = taskWrapper.querySelector('.add-subitem-input');
            if (input) {
                input.remove();
            }
        }

        function addSubItem(taskId, text) {
            const task = data.tasks.find(t => t.id === taskId);
            if (!task) return;
            
            if (!task.subItems) {
                task.subItems = [];
            }
            
            task.subItems.push({
                id: Date.now(),
                text: text,
                completed: false,
                created: new Date().toISOString()
            });
            
            saveData();
            renderTasks();
        }

        function toggleSubItem(taskId, subItemId) {
            const task = data.tasks.find(t => t.id === taskId);
            if (!task || !task.subItems) return;
            
            const subItem = task.subItems.find(si => si.id === subItemId);
            if (subItem) {
                subItem.completed = !subItem.completed;
                saveData();
                renderTasks();
            }
        }

        function deleteSubItem(taskId, subItemId) {
            const task = data.tasks.find(t => t.id === taskId);
            if (!task || !task.subItems) return;
            
            task.subItems = task.subItems.filter(si => si.id !== subItemId);
            saveData();
            renderTasks();
        }

        function editNote(id) {
            const note = data.notes.find(n => n.id === id);
            if (!note || note.archived) return;

            const noteCard = document.querySelector(`[data-note-id="${id}"]`);
            const contentDiv = noteCard.querySelector('.item-content');
            const tagsDiv = noteCard.querySelector('.item-tags');
            const actionsDiv = noteCard.querySelector('.item-actions');

            // Store original content
            const originalText = note.text;
            const originalTags = note.tags || [];

            // Create edit form
            const editForm = document.createElement('div');
            editForm.className = 'edit-form';
            editForm.innerHTML = `
                <textarea class="edit-textarea">${escapeHtml(originalText)}</textarea>
                <input type="text" class="edit-tags" placeholder="Tags (comma-separated)" 
                       value="${originalTags.join(', ')}">
                <div class="edit-actions">
                    <button class="save-btn" onclick="saveEdit(${id})">Save</button>
                    <button class="cancel-btn" onclick="cancelEdit(${id})">Cancel</button>
                </div>
            `;

            // Replace content with edit form
            contentDiv.replaceWith(editForm);
            if (tagsDiv) tagsDiv.style.display = 'none';
            actionsDiv.style.display = 'none';

            // Focus on textarea
            editForm.querySelector('.edit-textarea').focus();
        }

        function saveEdit(id) {
            const note = data.notes.find(n => n.id === id);
            if (!note) return;

            const noteCard = document.querySelector(`[data-note-id="${id}"]`);
            const editForm = noteCard.querySelector('.edit-form');
            const textarea = editForm.querySelector('.edit-textarea');
            const tagsInput = editForm.querySelector('.edit-tags');

            const newText = textarea.value.trim();
            const newTagsText = tagsInput.value.trim();
            const newTags = newTagsText ? newTagsText.split(',').map(tag => tag.trim()).filter(tag => tag) : [];

            if (newText) {
                note.text = newText;
                note.tags = newTags;
                note.lastModified = new Date().toISOString();
                
                saveData();
                renderTagFilters();
                renderNotes();
            } else {
                alert('Note content cannot be empty');
            }
        }

        function cancelEdit(id) {
            renderNotes();
        }

        function archiveOldNotes() {
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            let archived = 0;
            data.notes.forEach(note => {
                if (new Date(note.date) < thirtyDaysAgo && !note.archived) {
                    note.archived = true;
                    archived++;
                }
            });
            
            if (archived > 0) {
                alert(`Archived ${archived} notes older than 30 days`);
                saveData();
                renderNotes();
            } else {
                alert('No notes older than 30 days found');
            }
        }

        function archiveCompletedTasks() {
            let archived = 0;
            data.tasks.forEach(task => {
                if (task.completed && !task.archived) {
                    task.archived = true;
                    archived++;
                }
            });
            
            if (archived > 0) {
                alert(`Archived ${archived} completed tasks`);
                saveData();
                renderTasks();
            } else {
                alert('No completed tasks to archive');
            }
        }

        function toggleNotesView(view) {
            currentView.notes = view;
            document.getElementById('notesActiveBtn').classList.toggle('active', view === 'active');
            document.getElementById('notesArchivedBtn').classList.toggle('active', view === 'archived');
            renderNotes();
        }

        function toggleTasksView(view) {
            currentView.tasks = view;
            document.getElementById('tasksActiveBtn').classList.toggle('active', view === 'active');
            document.getElementById('tasksArchivedBtn').classList.toggle('active', view === 'archived');
            renderTasks();
        }

        // Task Groups Management
        function showNewGroupPrompt() {
            const groupName = prompt('Enter group name:');
            if (groupName && groupName.trim()) {
                const emoji = prompt('Enter emoji for group (optional):', '📁');
                createGroup(groupName.trim(), emoji || '📁');
            }
        }

        function createGroup(name, emoji = '📁') {
            const newGroup = {
                id: Date.now(),
                name: name,
                emoji: emoji,
                order: data.taskGroups.length
            };
            
            data.taskGroups.push(newGroup);
            saveData();
            updateGroupSelect();
            renderTasks();
        }

        function deleteGroup(groupId) {
            const group = data.taskGroups.find(g => g.id === groupId);
            if (!group) return;
            
            const tasksInGroup = data.tasks.filter(t => t.groupId === groupId);
            
            let message = `Delete group "${group.name}"?`;
            if (tasksInGroup.length > 0) {
                message += `\n\n${tasksInGroup.length} task(s) will be moved to Ungrouped.`;
            }
            
            if (confirm(message)) {
                // Move tasks to ungrouped
                tasksInGroup.forEach(task => {
                    task.groupId = null;
                });
                
                // Remove group
                data.taskGroups = data.taskGroups.filter(g => g.id !== groupId);
                
                saveData();
                updateGroupSelect();
                renderTasks();
            }
        }

        function startEditGroupName(groupId) {
            const group = data.taskGroups.find(g => g.id === groupId);
            if (!group) return;
            
            const groupHeader = document.querySelector(`[data-group-id="${groupId}"] .group-header`);
            const titleElement = groupHeader.querySelector('.group-title-text');
            const actionsElement = groupHeader.querySelector('.group-actions');
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'group-title-input';
            input.value = group.name;
            input.setAttribute('data-group-id', groupId);
            
            titleElement.replaceWith(input);
            actionsElement.style.display = 'none';
            
            input.focus();
            input.select();
            
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    saveGroupName(groupId, input.value);
                } else if (e.key === 'Escape') {
                    cancelEditGroupName(groupId);
                }
            });
            
            input.addEventListener('blur', () => {
                saveGroupName(groupId, input.value);
            });
        }

        function saveGroupName(groupId, newName) {
            const group = data.taskGroups.find(g => g.id === groupId);
            if (!group) return;
            
            const trimmedName = newName.trim();
            if (trimmedName && trimmedName !== group.name) {
                group.name = trimmedName;
                saveData();
            }
            
            updateGroupSelect();
            renderTasks();
        }

        function cancelEditGroupName(groupId) {
            renderTasks();
        }

        function updateGroupSelect() {
            const select = document.getElementById('taskGroupSelect');
            const currentValue = select.value;
            
            select.innerHTML = '<option value="">Ungrouped</option>';
            
            data.taskGroups.forEach(group => {
                const option = document.createElement('option');
                option.value = group.id;
                option.textContent = `${group.emoji} ${group.name}`;
                if (group.id.toString() === currentValue) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

        // Drag and Drop functionality
        function setupDragAndDrop() {
            const container = document.getElementById('tasksList');
            
            container.addEventListener('dragstart', (e) => {
                const wrapper = e.target.closest('.task-item-wrapper');
                if (wrapper && wrapper.draggable) {
                    const taskId = parseInt(wrapper.getAttribute('data-task-id'));
                    draggedTask = data.tasks.find(t => t.id === taskId);
                    wrapper.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                }
            });
            
            container.addEventListener('dragend', (e) => {
                const wrapper = e.target.closest('.task-item-wrapper');
                if (wrapper) {
                    wrapper.classList.remove('dragging');
                    draggedTask = null;
                }
                
                // Remove drag-over class from all groups
                document.querySelectorAll('.task-group').forEach(group => {
                    group.classList.remove('drag-over');
                });
            });
            
            container.addEventListener('dragover', (e) => {
                e.preventDefault();
                const group = e.target.closest('.task-group');
                if (group && draggedTask) {
                    e.dataTransfer.dropEffect = 'move';
                    
                    // Add drag-over effect
                    document.querySelectorAll('.task-group').forEach(g => {
                        g.classList.remove('drag-over');
                    });
                    group.classList.add('drag-over');
                }
            });
            
            container.addEventListener('drop', (e) => {
                e.preventDefault();
                const group = e.target.closest('.task-group');
                
                if (group && draggedTask) {
                    const groupIdAttr = group.getAttribute('data-group-id');
                    
                    // Handle Today bucket specially
                    if (groupIdAttr === 'today') {
                        draggedTask.isToday = true;
                        draggedTask.todayDate = new Date().toDateString();
                    } else {
                        // Moving out of Today or between regular groups
                        draggedTask.isToday = false;
                        draggedTask.todayDate = null;
                        
                        // Set the group
                        const targetGroupId = groupIdAttr === 'null' ? null : parseInt(groupIdAttr);
                        draggedTask.groupId = targetGroupId;
                    }
                    
                    saveData();
                    renderTasks();
                }
                
                // Remove drag-over class
                document.querySelectorAll('.task-group').forEach(g => {
                    g.classList.remove('drag-over');
                });
            });
            
            container.addEventListener('dragleave', (e) => {
                const group = e.target.closest('.task-group');
                if (group && !group.contains(e.relatedTarget)) {
                    group.classList.remove('drag-over');
                }
            });
        }

        // Render functions
        function renderNotes() {
            const container = document.getElementById('notesList');
            const showArchived = currentView.notes === 'archived';
            
            let filteredNotes = data.notes.filter(note => note.archived === showArchived);
            
            // Apply tag filtering
            if (selectedNoteTags.size > 0) {
                filteredNotes = filteredNotes.filter(note => {
                    if (!note.tags || note.tags.length === 0) return false;
                    
                    if (noteFilterMode === 'OR') {
                        // Note must have at least one of the selected tags
                        return Array.from(selectedNoteTags).some(tag => note.tags.includes(tag));
                    } else {
                        // Note must have all selected tags
                        return Array.from(selectedNoteTags).every(tag => note.tags.includes(tag));
                    }
                });
            }
            
            if (filteredNotes.length === 0) {
                let filterText = '';
                if (selectedNoteTags.size > 0) {
                    const tagsText = Array.from(selectedNoteTags).join(', ');
                    filterText = ` with tag${selectedNoteTags.size > 1 ? 's' : ''} "${tagsText}"`;
                }
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">📝</div>
                        <p>${showArchived ? 'No archived notes' : 'No active notes'}${filterText}</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filteredNotes.map(note => `
                <div class="item-card ${note.archived ? 'archived' : ''}" data-note-id="${note.id}">
                    <div class="item-content">${escapeHtml(note.text)}</div>
                    ${note.tags && note.tags.length > 0 ? `
                        <div class="item-tags">
                            ${note.tags.map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join('')}
                        </div>
                    ` : ''}
                    <div class="item-footer">
                        <div class="item-date">
                            ${formatDate(note.date)}
                            ${note.lastModified ? ` (edited ${formatDate(note.lastModified)})` : ''}
                        </div>
                        <div class="item-actions">
                            ${!note.archived ? `
                                <button class="action-btn" onclick="editNote(${note.id})">Edit</button>
                            ` : ''}
                            <button class="action-btn" onclick="toggleArchive('notes', ${note.id})">
                                ${note.archived ? 'Unarchive' : 'Archive'}
                            </button>
                            <button class="action-btn danger" onclick="deleteItem('notes', ${note.id})">Delete</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderReminders() {
            const container = document.getElementById('remindersList');
            const today = new Date().toDateString();
            
            if (data.reminders.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">⏰</div>
                        <p>No reminders yet</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = data.reminders.map(reminder => {
                const reminderDate = new Date(reminder.date);
                const isOverdue = reminderDate < new Date() && reminderDate.toDateString() !== today;
                const isToday = reminderDate.toDateString() === today;
                
                let cardClass = 'item-card';
                let dueBadge = '';
                
                if (isOverdue) {
                    cardClass += ' reminder-overdue';
                }
                if (isToday) {
                    cardClass += ' reminder-due-today';
                    dueBadge = '<div class="due-badge">Due Today</div>';
                }
                
                return `
                    <div class="${cardClass}">
                        ${dueBadge}
                        <div class="item-content">${escapeHtml(reminder.text)}</div>
                        <div class="item-footer">
                            <div class="item-date">Due: ${formatDate(reminder.date)}</div>
                            <div class="item-actions">
                                <button class="action-btn danger" onclick="deleteItem('reminders', ${reminder.id})">Delete</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderTasks() {
            const container = document.getElementById('tasksList');
            const showArchived = currentView.tasks === 'archived';
            
            // Check if it's a new day and clear old Today tasks
            checkAndClearOldTodayTasks();
            
            // Filter tasks by archive status
            const filteredTasks = data.tasks.filter(task => task.archived === showArchived);
            
            if (filteredTasks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">✅</div>
                        <p>${showArchived ? 'No archived tasks' : 'No tasks yet. Create your first task above!'}</p>
                    </div>
                `;
                return;
            }
            
            // Separate Today tasks from others
            const todayTasks = filteredTasks.filter(task => task.isToday);
            const otherTasks = filteredTasks.filter(task => !task.isToday);
            
            // Group other tasks
            const groupedTasks = {};
            const ungroupedTasks = [];
            
            otherTasks.forEach(task => {
                if (task.groupId === null) {
                    ungroupedTasks.push(task);
                } else {
                    if (!groupedTasks[task.groupId]) {
                        groupedTasks[task.groupId] = [];
                    }
                    groupedTasks[task.groupId].push(task);
                }
            });
            
            let html = '';
            
            // Render Today bucket first (only if not archived view)
            if (!showArchived) {
                html += renderTodayBucket(todayTasks);
            }
            
            // Render each regular group
            data.taskGroups.forEach(group => {
                const tasksInGroup = groupedTasks[group.id] || [];
                html += renderTaskGroup(group, tasksInGroup, showArchived);
            });
            
            // Render ungrouped tasks
            html += renderUngroupedTasks(ungroupedTasks, showArchived);
            
            container.innerHTML = html;
            
            // Setup drag and drop after rendering
            if (!showArchived) {
                setupDragAndDrop();
            }
        }
        
        function renderTodayBucket(tasks) {
            const sortedTasks = [...tasks].sort((a, b) => a.completed - b.completed);
            
            return `
                <div class="task-group today-group" data-group-id="today">
                    <div class="group-header">
                        <div class="group-title">
                            <span>📅</span>
                            <span class="group-title-text">Today</span>
                            <span class="group-count">${tasks.length}</span>
                        </div>
                    </div>
                    <div class="task-list">
                        ${sortedTasks.length === 0 ? `
                            <div class="empty-group">
                                <div class="empty-icon">📌</div>
                                <div>Drag tasks here to work on them today</div>
                            </div>
                        ` : sortedTasks.map(task => renderTaskItemWithTodayToggle(task, false)).join('')}
                    </div>
                </div>
            `;
        }
        
        function renderTaskItemWithTodayToggle(task, isArchived) {
            const subItems = task.subItems || [];
            const completedSubItems = subItems.filter(si => si.completed).length;
            const progressText = subItems.length > 0 ? `<span class="task-progress">(${completedSubItems}/${subItems.length})</span>` : '';
            
            let subItemsHtml = '';
            if (subItems.length > 0) {
                subItemsHtml = `
                    <div class="task-subitems">
                        ${subItems.map(subItem => `
                            <div class="subitem ${subItem.completed ? 'completed' : ''}">
                                <input type="checkbox" 
                                       class="subitem-checkbox" 
                                       ${subItem.completed ? 'checked' : ''} 
                                       onchange="toggleSubItem(${task.id}, ${subItem.id})"
                                       ${isArchived ? 'disabled' : ''}>
                                <span class="subitem-text">${escapeHtml(subItem.text)}</span>
                                ${!isArchived ? `
                                    <div class="subitem-actions">
                                        <button class="subitem-btn" onclick="deleteSubItem(${task.id}, ${subItem.id})">×</button>
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            const addButtonHtml = !isArchived && subItems.length > 0 ? `
                <button class="add-subitem-btn" onclick="showAddSubItemInput(${task.id})">
                    <span>+</span> Add sub-item
                </button>
            ` : '';
            
            const todayToggleButton = !isArchived ? `
                <button class="task-action-btn" onclick="toggleTaskToday(${task.id})" title="${task.isToday ? 'Remove from Today' : 'Add to Today'}" style="font-size: 13px;">
                    ${task.isToday ? '📅✓' : '📅'}
                </button>
            ` : '';
            
            return `
                <div class="task-item-wrapper" draggable="${!isArchived}" data-task-id="${task.id}">
                    <div class="task-item ${task.completed ? 'completed' : ''}">
                        ${!isArchived ? '<span class="task-drag-handle">⋮⋮</span>' : ''}
                        <input type="checkbox" 
                               class="task-checkbox" 
                               ${task.completed ? 'checked' : ''} 
                               onchange="toggleTask(${task.id})" 
                               ${isArchived ? 'disabled' : ''}>
                        <div class="task-text">${escapeHtml(task.text)}${progressText}</div>
                        <div class="task-actions">
                            ${todayToggleButton}
                            ${!isArchived && subItems.length === 0 ? `
                                <button class="task-action-btn" onclick="showAddSubItemInput(${task.id})" title="Add sub-item">+</button>
                            ` : ''}
                            <button class="task-action-btn danger" onclick="deleteTask(${task.id})">×</button>
                        </div>
                    </div>
                    ${subItemsHtml}
                    ${addButtonHtml}
                </div>
            `;
        }

        function renderTaskGroup(group, tasks, isArchived) {
            const sortedTasks = [...tasks].sort((a, b) => a.completed - b.completed);
            
            return `
                <div class="task-group" data-group-id="${group.id}">
                    <div class="group-header">
                        <div class="group-title">
                            <span>${group.emoji}</span>
                            <span class="group-title-text">${escapeHtml(group.name)}</span>
                            <span class="group-count">${tasks.length}</span>
                        </div>
                        ${!isArchived ? `
                            <div class="group-actions">
                                <button class="group-action-btn" onclick="startEditGroupName(${group.id})" title="Rename">✏️</button>
                                <button class="group-action-btn" onclick="deleteGroup(${group.id})" title="Delete">🗑️</button>
                            </div>
                        ` : ''}
                    </div>
                    <div class="task-list">
                        ${sortedTasks.length === 0 ? `
                            <div class="empty-group">
                                <div class="empty-icon">📭</div>
                                <div>Drag tasks here or add new ones</div>
                            </div>
                        ` : sortedTasks.map(task => renderTaskItemWithTodayToggle(task, isArchived)).join('')}
                    </div>
                </div>
            `;
        }

        function renderUngroupedTasks(tasks, isArchived) {
            if (tasks.length === 0 && data.taskGroups.length > 0) {
                return '';
            }
            
            const sortedTasks = [...tasks].sort((a, b) => a.completed - b.completed);
            
            return `
                <div class="task-group no-group" data-group-id="null">
                    <div class="group-header">
                        <div class="group-title">
                            <span>📋</span>
                            <span class="group-title-text">Ungrouped</span>
                            <span class="group-count">${tasks.length}</span>
                        </div>
                    </div>
                    <div class="task-list">
                        ${sortedTasks.length === 0 ? `
                            <div class="empty-group">
                                <div class="empty-icon">📭</div>
                                <div>No ungrouped tasks</div>
                            </div>
                        ` : sortedTasks.map(task => renderTaskItemWithTodayToggle(task, isArchived)).join('')}
                    </div>
                </div>
            `;
        }

        function renderTaskItem(task, isArchived) {
            // Keep the old function for backward compatibility if needed
            return renderTaskItemWithTodayToggle(task, isArchived);
        }

        function renderAll() {
            renderTagFilters();
            updateReportTags();
            updateGroupSelect();
            renderNotes();
            renderReminders();
            renderTasks();
        }

        function renderTagFilters() {
            const container = document.getElementById('tagFilterOptions');
            const filterLabel = document.getElementById('tagFilterLabel');
            const filterCount = document.getElementById('tagFilterCount');
            
            const allTags = new Set();
            data.notes.forEach(note => {
                if (note.tags) {
                    note.tags.forEach(tag => allTags.add(tag));
                }
            });
            
            // Update button label and count
            if (selectedNoteTags.size > 0) {
                filterLabel.textContent = `Filtering by ${selectedNoteTags.size} tag${selectedNoteTags.size > 1 ? 's' : ''}`;
                filterCount.textContent = selectedNoteTags.size;
                filterCount.style.display = 'inline-block';
            } else {
                filterLabel.textContent = 'Filter by tags';
                filterCount.style.display = 'none';
            }
            
            if (allTags.size === 0) {
                container.innerHTML = '<span style="color: #6c757d; font-size: 12px;">No tags available</span>';
                return;
            }
            
            const tagsArray = Array.from(allTags).sort();
            container.innerHTML = tagsArray.map(tag => `
                <button class="filter-tag ${selectedNoteTags.has(tag) ? 'selected' : ''}" 
                        onclick="toggleNoteTag('${escapeHtml(tag).replace(/'/g, "\\'")}')">
                    ${escapeHtml(tag)}
                </button>
            `).join('');
            
            // Add AND/OR toggle if multiple tags are selected
            if (selectedNoteTags.size > 1) {
                const modeToggle = document.createElement('button');
                modeToggle.className = 'secondary-btn';
                modeToggle.style.fontSize = '11px';
                modeToggle.style.padding = '6px 12px';
                modeToggle.style.marginTop = '8px';
                modeToggle.style.width = '100%';
                modeToggle.textContent = noteFilterMode === 'OR' ? 'Mode: Match ANY tag' : 'Mode: Match ALL tags';
                modeToggle.onclick = toggleFilterMode;
                container.appendChild(modeToggle);
            }
        }
        
        function toggleTagFilterPanel() {
            const panel = document.getElementById('tagFilterPanel');
            panel.classList.toggle('hidden');
        }
        
        function toggleNoteTag(tag) {
            if (selectedNoteTags.has(tag)) {
                selectedNoteTags.delete(tag);
            } else {
                selectedNoteTags.add(tag);
            }
            renderTagFilters();
            renderNotes();
        }
        
        function clearTagFilters() {
            selectedNoteTags.clear();
            renderTagFilters();
            renderNotes();
            toggleTagFilterPanel(); // Close the panel after clearing
        }
        
        function toggleFilterMode() {
            noteFilterMode = noteFilterMode === 'OR' ? 'AND' : 'OR';
            renderTagFilters();
            renderNotes();
        }

        function updateTagFilter() {
            // Legacy function - replaced by renderTagFilters
            renderTagFilters();
        }

        // Reports functionality
        function openReportsModal() {
            document.getElementById('reportsModal').classList.remove('hidden');
            updateReportTags();
        }

        function closeReportsModal() {
            document.getElementById('reportsModal').classList.add('hidden');
        }

        function generateReport() {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            end.setHours(23, 59, 59, 999);
            
            let filteredNotes = data.notes.filter(note => {
                const noteDate = new Date(note.date);
                return noteDate >= start && noteDate <= end;
            });
            
            const filteredReminders = data.reminders.filter(reminder => {
                const reminderDate = new Date(reminder.date);
                return reminderDate >= start && reminderDate <= end;
            });
            
            const filteredTasks = data.tasks.filter(task => {
                const taskDate = new Date(task.completedDate || task.created);
                return taskDate >= start && taskDate <= end;
            });
            
            if (reportTags.size > 0) {
                filteredNotes = filteredNotes.filter(note => {
                    if (!note.tags || note.tags.length === 0) return false;
                    return Array.from(reportTags).some(tag => note.tags.includes(tag));
                });
            }
            
            let report = `PRODUCTIVITY REPORT\n`;
            report += `Period: ${formatDate(startDate)} to ${formatDate(endDate)}\n`;
            if (reportTags.size > 0) {
                report += `Filtered by tags: ${Array.from(reportTags).join(', ')}\n`;
            }
            report += `Generated: ${formatDate(new Date().toISOString())}\n\n`;
            
            report += `COMPLETED WORK:\n`;
            report += `=================\n`;
            if (filteredNotes.length > 0) {
                filteredNotes.forEach(note => {
                    report += `• ${note.text.replace(/\n/g, '\n  ')} (${formatDate(note.date)})`;
                    if (note.tags && note.tags.length > 0) {
                        report += ` [${note.tags.join(', ')}]`;
                    }
                    report += `\n`;
                });
            } else {
                const tagText = reportTags.size > 0 ? ' matching the selected tags' : '';
                report += `No notes recorded for this period${tagText}.\n`;
            }
            
            report += `\nREMINDERS/DEADLINES:\n`;
            report += `====================\n`;
            if (filteredReminders.length > 0) {
                filteredReminders.forEach(reminder => {
                    report += `• ${reminder.text} (Due: ${formatDate(reminder.date)})\n`;
                });
            } else {
                report += `No reminders for this period.\n`;
            }
            
            report += `\nTASKS:\n`;
            report += `======\n`;
            const completedTasks = filteredTasks.filter(task => task.completed);
            const pendingTasks = filteredTasks.filter(task => !task.completed);
            
            if (completedTasks.length > 0) {
                report += `Completed:\n`;
                completedTasks.forEach(task => {
                    report += `✓ ${task.text} (${formatDate(task.completedDate)})\n`;
                });
            }
            
            if (pendingTasks.length > 0) {
                report += `\nPending:\n`;
                pendingTasks.forEach(task => {
                    report += `○ ${task.text} (Created: ${formatDate(task.created)})\n`;
                });
            }
            
            if (completedTasks.length === 0 && pendingTasks.length === 0) {
                report += `No tasks for this period.\n`;
            }
            
            report += `\nSUMMARY:\n`;
            report += `========\n`;
            report += `Notes: ${filteredNotes.length}\n`;
            report += `Reminders: ${filteredReminders.length}\n`;
            report += `Completed Tasks: ${completedTasks.length}\n`;
            report += `Pending Tasks: ${pendingTasks.length}\n`;
            if (reportTags.size > 0) {
                report += `Tag Filter Applied: ${Array.from(reportTags).join(', ')}\n`;
            }
            
            document.getElementById('reportOutput').textContent = report;
            document.getElementById('reportOutput').classList.remove('hidden');
        }

        function copyReport() {
            const reportText = document.getElementById('reportOutput').textContent;
            if (reportText) {
                navigator.clipboard.writeText(reportText).then(() => {
                    alert('Report copied to clipboard!');
                });
            }
        }

        function updateReportTags() {
            const allTags = new Set();
            data.notes.forEach(note => {
                if (note.tags) {
                    note.tags.forEach(tag => allTags.add(tag));
                }
            });
            
            const availableContainer = document.getElementById('availableTagsContainer');
            const selectedContainer = document.getElementById('selectedTagsContainer');
            
            if (allTags.size === 0) {
                availableContainer.innerHTML = '<p style="color: #6c757d; font-size: 14px;">No tags available</p>';
            } else {
                availableContainer.innerHTML = Array.from(allTags).sort().map(tag => `
                    <button class="filter-tag ${reportTags.has(tag) ? 'selected' : ''}" onclick="toggleReportTag('${tag}')">
                        ${escapeHtml(tag)}
                    </button>
                `).join('');
            }
            
            if (reportTags.size === 0) {
                selectedContainer.innerHTML = '<p style="color: #6c757d; font-size: 14px; margin: 8px;">Click tags above to add filters</p>';
            } else {
                selectedContainer.innerHTML = Array.from(reportTags).map(tag => `
                    <div class="selected-tag">
                        ${escapeHtml(tag)}
                        <button class="remove-tag" onclick="removeReportTag('${tag}')" title="Remove filter">×</button>
                    </div>
                `).join('');
            }
        }

        function toggleReportTag(tag) {
            if (reportTags.has(tag)) {
                reportTags.delete(tag);
            } else {
                reportTags.add(tag);
            }
            updateReportTags();
        }

        function removeReportTag(tag) {
            reportTags.delete(tag);
            updateReportTags();
        }

        function clearReportTags() {
            reportTags.clear();
            updateReportTags();
        }

        // Utility functions
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-GB', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function setDefaultReportDates() {
            const end = new Date();
            const start = new Date();
            start.setDate(start.getDate() - 30);
            
            document.getElementById('reportStartDate').value = start.toISOString().split('T')[0];
            document.getElementById('reportEndDate').value = end.toISOString().split('T')[0];
        }

        // Authentication state management
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            
            if (user) {
                document.getElementById('authSection').classList.add('hidden');
                document.getElementById('appContent').classList.remove('hidden');
                document.getElementById('userEmail').textContent = user.email;
                
                document.getElementById('emailInput').value = '';
                document.getElementById('passwordInput').value = '';
                
                loadData();
                setupRealtimeSync();
                setDefaultReportDates();
                document.getElementById('reminderDate').value = new Date().toISOString().split('T')[0];
                
            } else {
                document.getElementById('authSection').classList.remove('hidden');
                document.getElementById('appContent').classList.add('hidden');
                
                if (unsubscribeData) {
                    unsubscribeData();
                    unsubscribeData = null;
                }
                data = { notes: [], reminders: [], tasks: [], taskGroups: [] };
            }
        });

        // Keyboard shortcuts and event listeners
        document.addEventListener('DOMContentLoaded', function() {
            document.addEventListener('keypress', function(e) {
                if (e.target.id === 'noteInput' && e.key === 'Enter' && e.ctrlKey) {
                    e.preventDefault();
                    addNote();
                }
                
                if (e.target.id === 'taskInput' && e.key === 'Enter') {
                    e.preventDefault();
                    addTask();
                }
                
                if (e.target.id === 'reminderText' && e.key === 'Enter') {
                    e.preventDefault();
                    addReminder();
                }
                
                if (e.target.id === 'noteTagsInput' && e.key === 'Enter') {
                    e.preventDefault();
                    addNote();
                }
                
                if ((e.target.id === 'emailInput' || e.target.id === 'passwordInput') && e.key === 'Enter') {
                    e.preventDefault();
                    signIn();
                }
            });

            // Close modal when clicking outside
            document.getElementById('reportsModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeReportsModal();
                }
            });
            
            // Close tag filter panel when clicking outside
            document.addEventListener('click', function(e) {
                const panel = document.getElementById('tagFilterPanel');
                const toggle = document.getElementById('tagFilterToggle');
                
                if (!panel.classList.contains('hidden') && 
                    !panel.contains(e.target) && 
                    !toggle.contains(e.target)) {
                    toggleTagFilterPanel();
                }
            });
        });
    </script>
</body>
</html>
